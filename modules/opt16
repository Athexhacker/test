#!/bin/bash
# Written in Bash
# "ONLY FOR EDUCATIONAL PURPOSE"
# OPTION 16: ESTABLISH REMOTE CONNECTION - ANDRO-EYE

# Color codes
RED='\033[0;91m'
GREEN='\033[0;92m'
YELLOW='\033[0;93m'
BLUE='\033[0;94m'
PURPLE='\033[0;95m'
CYAN='\033[0;96m'
WHITE='\033[0;97m'
NC='\033[0m' # No Color
BOLD='\033[1m'
UNDERLINE='\033[4m'
BLINK='\033[5m'

# Animation functions
loading_animation() {
    local message=$1
    local chars="â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â "
    
    echo -ne "${CYAN}${BOLD}$message ${NC}"
    for i in {1..15}; do
        for char in $(echo $chars | grep -o .); do
            echo -ne "${YELLOW}${BOLD}$char${NC}"
            sleep 0.05
            echo -ne "\b"
        done
    done
    echo -e "${GREEN}${BOLD} Done! ${NC}"
}

progress_bar() {
    local duration=$1
    local message=$2
    local width=40
    
    echo -ne "${BLUE}${BOLD}$message ${NC}"
    for ((i=0; i<=width; i++)); do
        local percent=$((i * 100 / width))
        echo -ne "\r${BLUE}${BOLD}$message ${NC}["
        for ((j=0; j<i; j++)); do echo -ne "${GREEN}â–“${NC}"; done
        for ((j=i; j<width; j++)); do echo -ne "${WHITE}â–‘${NC}"; done
        echo -ne "] ${percent}%"
        sleep $(echo "scale=2; $duration/width" | bc 2>/dev/null || echo "0.05")
    done
    echo -e "\n"
}

sparkle_effect() {
    echo -ne "${YELLOW}"
    for i in {1..15}; do
        echo -ne "âœ¦"
        sleep 0.03
    done
    echo -e "${NC}"
}

pulse_message() {
    local message=$1
    local color=$2
    
    for i in {1..3}; do
        echo -ne "${color}${BOLD}$message${NC}"
        sleep 0.2
        echo -ne "\r"
        for j in $(seq 1 ${#message}); do
            echo -n " "
        done
        echo -ne "\r"
        sleep 0.2
    done
    echo -e "${color}${BOLD}$message${NC}"
}

# Function to display device in a box
display_device_box() {
    local number=$1
    local device=$2
    local model=$3
    local status=$4
    
    echo -e "${YELLOW}${BOLD}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${YELLOW}${BOLD}â”‚${NC}  ${GREEN}${BOLD}DEVICE #${number}${NC}                                        ${YELLOW}â”‚${NC}"
    echo -e "${YELLOW}${BOLD}â”‚${NC}      ${CYAN}ID:${NC} ${WHITE}${device:0:15}...${NC}                     ${YELLOW}â”‚${NC}"
    echo -e "${YELLOW}${BOLD}â”‚${NC}      ${PURPLE}Model:${NC} ${WHITE}$model${NC}                                 ${YELLOW}â”‚${NC}"
    echo -e "${YELLOW}${BOLD}â”‚${NC}      ${BLUE}Status:${NC} $status                           ${YELLOW}â”‚${NC}"
    echo -e "${YELLOW}${BOLD}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
}

# Function to get local IP addresses
show_local_ips() {
    echo -e "\n${CYAN}${BOLD}ğŸŒ Local Network Interfaces:${NC}"
    echo -e "${BLUE}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    
    # Get all local IPs
    if command -v ip &>/dev/null; then
        ip -4 addr show | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | while read ip; do
            if [[ ! "$ip" == 127.* ]]; then
                echo -e "  ${GREEN}â€¢${NC} ${WHITE}$ip${NC}"
            fi
        done
    elif command -v ifconfig &>/dev/null; then
        ifconfig | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | grep -v '127.0.0.1' | while read ip; do
            echo -e "  ${GREEN}â€¢${NC} ${WHITE}$ip${NC}"
        done
    else
        echo -e "  ${YELLOW}Could not detect local IPs${NC}"
    fi
    echo -e "${BLUE}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
}

# Function to find device IP
ip_finder() {
    local device=$1
    
    # Try different methods to get IP
    local dev_ip=""
    
    # Method 1: wlan0
    dev_ip=$(adb -s "$device" shell ip addr show wlan0 2>/dev/null | grep "inet\s" | awk '{print $2}' | awk -F'/' '{print $1}')
    
    # Method 2: eth0
    if [ -z "$dev_ip" ]; then
        dev_ip=$(adb -s "$device" shell ip addr show eth0 2>/dev/null | grep "inet\s" | awk '{print $2}' | awk -F'/' '{print $1}')
    fi
    
    # Method 3: getprop
    if [ -z "$dev_ip" ]; then
        dev_ip=$(adb -s "$device" shell getprop dhcp.wlan0.ipaddress 2>/dev/null)
    fi
    
    # Method 4: ifconfig
    if [ -z "$dev_ip" ]; then
        dev_ip=$(adb -s "$device" shell ifconfig wlan0 2>/dev/null | grep "inet addr" | awk -F':' '{print $2}' | awk '{print $1}')
    fi
    
    echo "$dev_ip"
}

# Function to test connectivity
test_connectivity() {
    local ip=$1
    
    if ping -c 1 -W 2 "$ip" &>/dev/null; then
        return 0
    else
        return 1
    fi
}

# Function for remote shell
remote_shell() {
    local device=$1
    local model=$2
    local ip=$3
    
    echo -e "\n${YELLOW}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}${BOLD}ğŸ”Œ Remote connection established to ${WHITE}$model${NC}"
    echo -e "${GREEN}${BOLD}ğŸ“¡ IP Address: ${WHITE}$ip${NC}"
    echo -e "${YELLOW}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
    
    while true; do
        echo -ne "\n${CYAN}${BOLD}â“ Launch remote shell? ${WHITE}(Y/n) ${CYAN}â¤ ${RED}"
        read yn
        echo -ne "${NC}"
        
        case ${yn,,} in
            n|no)
                echo -e "\n${BLUE}${BOLD}â© Skipping shell${NC}"
                break
                ;;
            *)
                echo -e "\n${PURPLE}${BOLD}ğŸš€ Opening remote shell to ${WHITE}$model${NC}"
                echo -e "${YELLOW}${BOLD}Type 'exit' to return${NC}\n"
                sleep 1
                
                # Connect to the remote device
                adb connect "$ip:5555" > /dev/null 2>&1
                
                if [ $? -eq 0 ]; then
                    # Open shell
                    adb -s "$ip:5555" shell
                    
                    # Disconnect after shell closes
                    echo -e "\n${BLUE}${BOLD}ğŸ”Œ Disconnecting remote session...${NC}"
                    adb disconnect "$ip:5555" > /dev/null 2>&1
                else
                    echo -e "${RED}${BOLD}âŒ Failed to connect to remote device${NC}"
                fi
                break
                ;;
        esac
    done
}

# Function to establish remote connection
establish_remote() {
    local device=$1
    local model=$2
    local device_num=$3
    
    echo -e "\n${YELLOW}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${PURPLE}${BOLD}ğŸŒ Establishing remote connection for:${NC}"
    display_device_box "$device_num" "$device" "$model" "${GREEN}â— Processing${NC}"
    
    # Check device connection
    echo -e "\n${BLUE}${BOLD}ğŸ” Verifying USB connection...${NC}"
    if ! adb -s "$device" get-state &>/dev/null; then
        pulse_message "âŒ Device not responding via USB!" "${RED}"
        return 1
    fi
    echo -e "${GREEN}${BOLD}âœ“ USB connection active${NC}"
    
    # Show local IPs for reference
    show_local_ips
    
    # Get device IP
    echo -e "\n${CYAN}${BOLD}ğŸ” Detecting device IP address...${NC}"
    loading_animation "Scanning network"
    
    local dev_ip=$(ip_finder "$device")
    
    if [ -z "$dev_ip" ]; then
        echo -e "\n${RED}${BOLD}âŒ Could not detect device IP address${NC}"
        echo -e "${YELLOW}${BOLD}Please ensure:${NC}"
        echo -e "  ${WHITE}â€¢ Device is connected to WiFi${NC}"
        echo -e "  ${WHITE}â€¢ WiFi is enabled on device${NC}"
        echo -e "  ${WHITE}â€¢ Device and PC are on same network${NC}"
        return 1
    fi
    
    echo -e "\n${GREEN}${BOLD}âœ… Device IP: ${WHITE}$dev_ip${NC}"
    
    # Test connectivity
    echo -e "\n${BLUE}${BOLD}ğŸ“¡ Testing network connectivity...${NC}"
    if test_connectivity "$dev_ip"; then
        echo -e "${GREEN}${BOLD}âœ“ Device is reachable on the network${NC}"
    else
        echo -e "${YELLOW}${BOLD}âš ï¸  Device is not responding to ping${NC}"
        echo -e "${WHITE}This may be normal if ICMP is blocked${NC}"
    fi
    
    # Instructions
    echo -e "\n${CYAN}${BOLD}ğŸ“‹ Remote Connection Process:${NC}"
    echo -e "${BLUE}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "  ${GREEN}1.${NC} Switching device to TCP/IP mode (port 5555)"
    echo -e "  ${GREEN}2.${NC} Connecting to ${WHITE}$dev_ip:5555${NC}"
    echo -e "  ${GREEN}3.${NC} Establishing remote session"
    echo -e "${BLUE}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}\n"
    
    # Confirm
    echo -ne "${YELLOW}${BOLD}â“ Proceed with remote connection? ${WHITE}(Y/n) ${YELLOW}â¤ ${RED}"
    read confirm
    echo -ne "${NC}"
    
    case ${confirm,,} in
        n|no)
            echo -e "\n${BLUE}${BOLD}â© Remote connection cancelled${NC}"
            return 0
            ;;
    esac
    
    # Switch to TCP/IP mode
    echo -e "\n${PURPLE}${BOLD}ğŸ”„ Switching device to TCP/IP mode...${NC}"
    progress_bar 3 "Configuring"
    
    local tcpip_result=$(adb -s "$device" tcpip 5555 2>&1)
    
    if [ $? -ne 0 ]; then
        echo -e "\n${RED}${BOLD}âŒ Failed to switch to TCP/IP mode${NC}"
        echo -e "${YELLOW}Error: ${WHITE}$tcpip_result${NC}"
        return 1
    fi
    
    echo -e "${GREEN}${BOLD}âœ“ Device switched to TCP/IP mode${NC}"
    
    # Wait for device to reconfigure
    echo -e "\n${BLUE}${BOLD}â³ Waiting for device to stabilize...${NC}"
    sleep 3
    
    # Connect to device
    echo -e "\n${CYAN}${BOLD}ğŸ”Œ Establishing remote connection...${NC}"
    
    local connect_result=$(adb connect "$dev_ip:5555" 2>&1)
    
    if [[ "$connect_result" == *"connected"* ]]; then
        echo -e "\n${GREEN}${BOLD}âœ… Remote connection established successfully!${NC}"
        
        # Show connection info
        echo -e "\n${YELLOW}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${YELLOW}${BOLD}â•‘         REMOTE CONNECTION ACTIVE           â•‘${NC}"
        echo -e "${YELLOW}${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
        echo -e "${YELLOW}${BOLD}â•‘${NC}  ${WHITE}Device:${NC}  ${GREEN}$model${NC}                               ${YELLOW}${BOLD}â•‘${NC}"
        echo -e "${YELLOW}${BOLD}â•‘${NC}  ${WHITE}IP:${NC}      ${GREEN}$dev_ip${NC}                           ${YELLOW}${BOLD}â•‘${NC}"
        echo -e "${YELLOW}${BOLD}â•‘${NC}  ${WHITE}Port:${NC}    ${GREEN}5555${NC}                                 ${YELLOW}${BOLD}â•‘${NC}"
        echo -e "${YELLOW}${BOLD}â•‘${NC}  ${WHITE}Status:${NC}  ${GREEN}â— Connected${NC}                           ${YELLOW}${BOLD}â•‘${NC}"
        echo -e "${YELLOW}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        
        # Ask for shell
        remote_shell "$device" "$model" "$dev_ip"
        
    else
        echo -e "\n${RED}${BOLD}âŒ Remote connection failed${NC}"
        echo -e "${YELLOW}Error: ${WHITE}$connect_result${NC}"
        
        # Troubleshooting tips
        echo -e "\n${CYAN}${BOLD}ğŸ’¡ Troubleshooting Tips:${NC}"
        echo -e "  ${WHITE}â€¢ Ensure both devices are on the same network${NC}"
        echo -e "  ${WHITE}â€¢ Check if port 5555 is open${NC}"
        echo -e "  ${WHITE}â€¢ Try disabling firewall temporarily${NC}"
        echo -e "  ${WHITE}â€¢ Verify WiFi connection on device${NC}"
    fi
    
    sparkle_effect
}

# Clear screen and show banner
clear
echo -e "${BLUE}${BOLD}"
cat << "EOF"
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â•‘
    â•‘  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•    â•‘
    â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â•‘
    â•‘  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•      â•‘
    â•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â•‘
    â•‘  â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â• â•šâ•â•â•â•â•â•    â•šâ•â•   â•šâ•â•â•â•â•â•â•    â•‘
    â•‘                                                          â•‘
    â•‘        ğŸŒ ${GREEN}REMOTE CONNECTION${BLUE} - ${CYAN}Wireless ADB Manager${BLUE}           â•‘
    â•‘                                                          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}"
sparkle_effect

# Create necessary directories
mkdir -p .temp 2>/dev/null

## DEVICE ID EXTRACT ##
echo -e "\n${BLUE}${BOLD}ğŸ” Scanning for connected devices...${NC}"
loading_animation "Detecting devices"

# Check if ADB is working
if ! command -v adb &> /dev/null; then
    pulse_message "âŒ ADB not found! Please install ADB first." "${RED}"
    sleep 2
    bash modules/funtion.sh
    exit 1
fi

adb devices | sed -n '2,$p' | awk '{ print $1 }' > .temp/dev_list_temp 2>/dev/null

# Check if any devices found
if [ ! -s ".temp/dev_list_temp" ]; then
    echo -e "\n${RED}${BOLD}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${RED}${BOLD}â”‚${NC}  ${RED}${BLINK}âš ï¸${NC}  ${WHITE}NO DEVICES CONNECTED${NC}                       ${RED}${BOLD}â”‚${NC}"
    echo -e "${RED}${BOLD}â”‚${NC}      ${CYAN}Please connect a device via USB first${NC}                ${RED}${BOLD}â”‚${NC}"
    echo -e "${RED}${BOLD}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    
    echo -e "\n${YELLOW}${BOLD}Press Enter to return to main menu...${NC}"
    read
    clear
    bash modules/funtion.sh
    exit 0
fi

# Read devices into array properly
mapfile -t dev < .temp/dev_list_temp 2>/dev/null

# Assign device variables with null checking
dev_1="${dev[0]:-}"
dev_2="${dev[1]:-}"
dev_3="${dev[2]:-}"

## DEVICE MODEL EXTRACT ##
adb devices -l | grep "model:" > .temp/dev_list_model_temp 2>/dev/null

# Extract models properly
mod_1=""
mod_2=""
mod_3=""

if [ -s ".temp/dev_list_model_temp" ]; then
    mapfile -t model_lines < .temp/dev_list_model_temp
    
    for i in "${!model_lines[@]}"; do
        model=$(echo "${model_lines[$i]}" | grep -o 'model:[^ ]*' | cut -d':' -f2)
        
        case $i in
            0) mod_1="$model" ;;
            1) mod_2="$model" ;;
            2) mod_3="$model" ;;
        esac
    done
fi

# Proper device count logic
total_dev=0
[ -n "$dev_1" ] && total_dev=1
[ -n "$dev_2" ] && total_dev=2
[ -n "$dev_3" ] && total_dev=3

# Device remote functions
dev_1_remo() {
    establish_remote "$dev_1" "${mod_1:-Unknown}" "1"
}

dev_2_remo() {
    establish_remote "$dev_2" "${mod_2:-Unknown}" "2"
}

dev_3_remo() {
    establish_remote "$dev_3" "${mod_3:-Unknown}" "3"
}

# Main device selection logic
echo -e "\n${GREEN}${BOLD}âœ… Scan Complete! Found ${WHITE}$total_dev${GREEN} device(s)${NC}\n"

echo -e "${YELLOW}${BOLD}âš ï¸  Note: Device must be on the same network as this PC${NC}\n"

case $total_dev in
    1)
        echo -e "${YELLOW}${BOLD}ğŸ“± Single device detected:${NC}\n"
        display_device_box "1" "$dev_1" "${mod_1:-Unknown}" "${GREEN}â— USB Connected${NC}"
        
        echo -e "\n${CYAN}${BOLD}Starting remote connection setup...${NC}"
        sleep 1
        dev_1_remo
        ;;
        
    2)
        echo -e "${YELLOW}${BOLD}ğŸ“± Multiple devices detected:${NC}\n"
        display_device_box "1" "$dev_1" "${mod_1:-Unknown}" "${GREEN}â— USB Connected${NC}"
        echo
        display_device_box "2" "$dev_2" "${mod_2:-Unknown}" "${GREEN}â— USB Connected${NC}"
        
        echo -e "\n${CYAN}${BOLD}Select device for remote connection:${NC}"
        while true; do
            echo -ne "\n${YELLOW}${BOLD}Enter device number (1-2) ${WHITE}â¤${NC} ${RED}"
            read options
            echo -ne "${NC}"
            
            case $options in
                1)
                    dev_1_remo
                    break
                    ;;
                2)
                    dev_2_remo
                    break
                    ;;
                *)
                    pulse_message "âŒ Invalid option! Choose 1 or 2" "${RED}"
                    ;;
            esac
        done
        ;;
        
    3)
        echo -e "${YELLOW}${BOLD}ğŸ“± Multiple devices detected:${NC}\n"
        display_device_box "1" "$dev_1" "${mod_1:-Unknown}" "${GREEN}â— USB Connected${NC}"
        echo
        display_device_box "2" "$dev_2" "${mod_2:-Unknown}" "${GREEN}â— USB Connected${NC}"
        echo
        display_device_box "3" "$dev_3" "${mod_3:-Unknown}" "${GREEN}â— USB Connected${NC}"
        
        echo -e "\n${CYAN}${BOLD}Select device for remote connection:${NC}"
        while true; do
            echo -ne "\n${YELLOW}${BOLD}Enter device number (1-3) ${WHITE}â¤${NC} ${RED}"
            read options
            echo -ne "${NC}"
            
            case $options in
                1)
                    dev_1_remo
                    break
                    ;;
                2)
                    dev_2_remo
                    break
                    ;;
                3)
                    dev_3_remo
                    break
                    ;;
                *)
                    pulse_message "âŒ Invalid option! Choose 1-3" "${RED}"
                    ;;
            esac
        done
        ;;
esac

# Clean up temp files
rm -f .temp/dev_list_temp .temp/dev_list_model_temp 2>/dev/null

# Return options
echo -e "\n${YELLOW}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${CYAN}${BOLD}â Options:${NC}"
echo -e "  ${GREEN}â€¢${NC} Press ${WHITE}ENTER${NC} to return to main menu"
echo -e "  ${GREEN}â€¢${NC} Type ${WHITE}'remote'${NC} to connect another device"
echo -e "  ${GREEN}â€¢${NC} Type ${WHITE}'exit'${NC} to quit\n"

echo -ne "${YELLOW}${BOLD}â“ Your choice ${WHITE}â¤${NC} ${RED}"
read user_choice
echo -ne "${NC}"

case ${user_choice,,} in
    "remote")
        echo -e "\n${PURPLE}${BOLD}ğŸ”„ Restarting remote connection...${NC}"
        sleep 1
        clear
        bash modules/opt16
        ;;
    "exit"|"quit")
        echo -e "\n${BLUE}${BOLD}ğŸ‘‹ Exiting to shell...${NC}"
        
        # Disconnect any remote connections
        adb disconnect > /dev/null 2>&1
        echo -e "${GREEN}${BOLD}âœ“ Remote connections closed${NC}"
        
        sparkle_effect
        exit 0
        ;;
    *)
        echo -e "\n${GREEN}${BOLD}â†©ï¸  Returning to main menu...${NC}"
        
        # Disconnect remote connections before returning
        adb disconnect > /dev/null 2>&1
        
        loading_animation "Loading"
        sleep 0.5
        clear
        bash modules/funtion.sh
        ;;
esac