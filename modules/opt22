#!/bin/bash
# Written in Bash
# "ONLY FOR EDUCATIONAL PURPOSE"
# OPTION 22: COPY ALL DEVICE STORAGE - ANDRO-EYE

# Color codes
RED='\033[0;91m'
GREEN='\033[0;92m'
YELLOW='\033[0;93m'
BLUE='\033[0;94m'
PURPLE='\033[0;95m'
CYAN='\033[0;96m'
WHITE='\033[0;97m'
NC='\033[0m' # No Color
BOLD='\033[1m'
UNDERLINE='\033[4m'
BLINK='\033[5m'

# Animation functions
loading_animation() {
    local message=$1
    local chars="â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â "
    
    echo -ne "${CYAN}${BOLD}$message ${NC}"
    for i in {1..15}; do
        for char in $(echo $chars | grep -o .); do
            echo -ne "${YELLOW}${BOLD}$char${NC}"
            sleep 0.05
            echo -ne "\b"
        done
    done
    echo -e "${GREEN}${BOLD} Done! ${NC}"
}

progress_bar() {
    local duration=$1
    local message=$2
    local width=40
    
    echo -ne "${BLUE}${BOLD}$message ${NC}"
    for ((i=0; i<=width; i++)); do
        local percent=$((i * 100 / width))
        echo -ne "\r${BLUE}${BOLD}$message ${NC}["
        for ((j=0; j<i; j++)); do echo -ne "${GREEN}â–“${NC}"; done
        for ((j=i; j<width; j++)); do echo -ne "${WHITE}â–‘${NC}"; done
        echo -ne "] ${percent}%"
        sleep $(echo "scale=2; $duration/width" | bc 2>/dev/null || echo "0.05")
    done
    echo -e "\n"
}

sparkle_effect() {
    echo -ne "${YELLOW}"
    for i in {1..15}; do
        echo -ne "âœ¦"
        sleep 0.03
    done
    echo -e "${NC}"
}

pulse_message() {
    local message=$1
    local color=$2
    
    for i in {1..3}; do
        echo -ne "${color}${BOLD}$message${NC}"
        sleep 0.2
        echo -ne "\r"
        for j in $(seq 1 ${#message}); do
            echo -n " "
        done
        echo -ne "\r"
        sleep 0.2
    done
    echo -e "${color}${BOLD}$message${NC}"
}

# Function to display device in a box
display_device_box() {
    local number=$1
    local device=$2
    local model=$3
    local status=$4
    
    echo -e "${YELLOW}${BOLD}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${YELLOW}${BOLD}â”‚${NC}  ${GREEN}${BOLD}DEVICE #${number}${NC}                                        ${YELLOW}â”‚${NC}"
    echo -e "${YELLOW}${BOLD}â”‚${NC}      ${CYAN}ID:${NC} ${WHITE}${device:0:15}...${NC}                     ${YELLOW}â”‚${NC}"
    echo -e "${YELLOW}${BOLD}â”‚${NC}      ${PURPLE}Model:${NC} ${WHITE}$model${NC}                                 ${YELLOW}â”‚${NC}"
    echo -e "${YELLOW}${BOLD}â”‚${NC}      ${BLUE}Status:${NC} $status                           ${YELLOW}â”‚${NC}"
    echo -e "${YELLOW}${BOLD}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
}

# Function to format bytes to human readable
format_bytes() {
    local bytes=$1
    if [ $bytes -lt 1024 ]; then
        echo "${bytes}B"
    elif [ $bytes -lt 1048576 ]; then
        echo "$((bytes / 1024))KB"
    elif [ $bytes -lt 1073741824 ]; then
        echo "$((bytes / 1048576))MB"
    else
        echo "$((bytes / 1073741824))GB"
    fi
}

# Function to get storage information
get_storage_info() {
    local device=$1
    
    echo -e "\n${BLUE}${BOLD}ğŸ’¾ Analyzing device storage...${NC}"
    
    # Get storage info using df
    local storage_info=$(adb -s "$device" shell df -h /sdcard 2>/dev/null | tail -1)
    if [ -n "$storage_info" ]; then
        local total=$(echo "$storage_info" | awk '{print $2}')
        local used=$(echo "$storage_info" | awk '{print $3}')
        local free=$(echo "$storage_info" | awk '{print $4}')
        local used_percent=$(echo "$storage_info" | awk '{print $5}')
        
        echo -e "\n${CYAN}${BOLD}ğŸ“Š Storage Overview:${NC}"
        echo -e "${BLUE}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
        echo -e "  ${GREEN}â€¢${NC} ${WHITE}Total space: ${YELLOW}$total${NC}"
        echo -e "  ${GREEN}â€¢${NC} ${WHITE}Used space: ${YELLOW}$used ${WHITE}($used_percent)${NC}"
        echo -e "  ${GREEN}â€¢${NC} ${WHITE}Free space: ${YELLOW}$free${NC}"
        echo -e "${BLUE}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    fi
    
    # Get folder sizes for major directories
    echo -e "\n${PURPLE}${BOLD}ğŸ“ Major folder sizes:${NC}"
    
    local folders=(
        "DCIM:Photos & Videos"
        "Download:Downloads"
        "WhatsApp:WhatsApp Data"
        "Music:Music"
        "Movies:Movies"
        "Pictures:Pictures"
        "Documents:Documents"
        "Android:Android Data"
    )
    
    for folder_info in "${folders[@]}"; do
        IFS=':' read -r folder desc <<< "$folder_info"
        local size=$(adb -s "$device" shell du -sh "/sdcard/$folder" 2>/dev/null | awk '{print $1}')
        if [ -n "$size" ] && [ "$size" != "0" ]; then
            echo -e "  ${GREEN}â€¢${NC} ${WHITE}$desc: ${YELLOW}$size${NC}"
        fi
    done
}

# Function to estimate copy time
estimate_copy_time() {
    local total_size_mb=$1
    
    # Rough estimate: ~10MB/s for USB 2.0
    local speed_mbps=10
    local time_seconds=$((total_size_mb / speed_mbps))
    
    if [ $time_seconds -lt 60 ]; then
        echo "${time_seconds} seconds"
    elif [ $time_seconds -lt 3600 ]; then
        echo "$((time_seconds / 60)) minutes $((time_seconds % 60)) seconds"
    else
        echo "$((time_seconds / 3600)) hours $(((time_seconds % 3600) / 60)) minutes"
    fi
}

# Function to show copy summary
show_copy_summary() {
    local dest_dir=$1
    
    if [ -d "$dest_dir" ]; then
        local total_files=$(find "$dest_dir" -type f 2>/dev/null | wc -l)
        local total_size=$(du -sh "$dest_dir" 2>/dev/null | cut -f1)
        local total_folders=$(find "$dest_dir" -type d 2>/dev/null | wc -l)
        
        echo -e "\n${CYAN}${BOLD}ğŸ“‹ Copy Summary:${NC}"
        echo -e "${BLUE}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
        echo -e "  ${GREEN}â€¢${NC} ${WHITE}Total files: ${YELLOW}$total_files${NC}"
        echo -e "  ${GREEN}â€¢${NC} ${WHITE}Total folders: ${YELLOW}$total_folders${NC}"
        echo -e "  ${GREEN}â€¢${NC} ${WHITE}Total size: ${YELLOW}$total_size${NC}"
        echo -e "  ${GREEN}â€¢${NC} ${WHITE}Destination: ${YELLOW}$dest_dir${NC}"
        echo -e "${BLUE}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
        
        # Show largest folders
        echo -e "\n${YELLOW}${BOLD}ğŸ“‚ Largest folders:${NC}"
        du -sh "$dest_dir"/* 2>/dev/null | sort -rh | head -5 | while read line; do
            echo -e "  ${GREEN}â€¢${NC} ${WHITE}$line${NC}"
        done
    fi
}

# Function to pull all data
pull_all_data() {
    local device=$1
    local model=$2
    local device_num=$3
    
    echo -e "\n${YELLOW}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${PURPLE}${BOLD}ğŸ’¿ Copying ALL data from:${NC}"
    display_device_box "$device_num" "$device" "$model" "${GREEN}â— Processing${NC}"
    
    # Check device connection
    echo -e "\n${BLUE}${BOLD}ğŸ” Verifying device connection...${NC}"
    if ! adb -s "$device" get-state &>/dev/null; then
        pulse_message "âŒ Device not responding!" "${RED}"
        return 1
    fi
    echo -e "${GREEN}${BOLD}âœ“ Device connected${NC}"
    
    # Show storage information
    get_storage_info "$device"
    
    # WARNING - This will copy a lot of data
    echo -e "\n${RED}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}${BOLD}â•‘                     âš ï¸  WARNING âš ï¸                          â•‘${NC}"
    echo -e "${RED}${BOLD}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${RED}${BOLD}â•‘${NC}  ${WHITE}You are about to copy ALL data from the device.        ${RED}${BOLD}â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘${NC}  ${WHITE}This includes:                                         ${RED}${BOLD}â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘${NC}  ${WHITE}â€¢ All photos and videos (DCIM)                        ${RED}${BOLD}â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘${NC}  ${WHITE}â€¢ All downloads                                        ${RED}${BOLD}â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘${NC}  ${WHITE}â€¢ App data (Android folder)                            ${RED}${BOLD}â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘${NC}  ${WHITE}â€¢ WhatsApp data                                        ${RED}${BOLD}â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘${NC}  ${WHITE}â€¢ Music, documents, and more                           ${RED}${BOLD}â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘${NC}  ${WHITE}â€¢ This may take a VERY LONG time                       ${RED}${BOLD}â•‘${NC}"
    echo -e "${RED}${BOLD}â•‘${NC}  ${WHITE}â€¢ Ensure you have enough free disk space               ${RED}${BOLD}â•‘${NC}"
    echo -e "${RED}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    # Estimate total size (rough estimate from df output)
    local total_size=$(adb -s "$device" shell df -k /sdcard 2>/dev/null | tail -1 | awk '{print $3}')
    if [ -n "$total_size" ]; then
        local total_size_mb=$((total_size / 1024))
        local estimated_time=$(estimate_copy_time $total_size_mb)
        echo -e "\n${YELLOW}${BOLD}â±ï¸  Estimated copy time: ${WHITE}$estimated_time${NC}"
    fi
    
    # Double confirmation
    echo -ne "\n${RED}${BOLD}â“ Are you ABSOLUTELY SURE you want to copy ALL data? ${WHITE}(yes/NO) ${RED}â¤ ${YELLOW}"
    read confirm_final
    echo -ne "${NC}"
    
    case ${confirm_final,,} in
        "yes")
            echo -e "\n${GREEN}${BOLD}Proceeding with full device copy...${NC}"
            ;;
        *)
            echo -e "\n${BLUE}${BOLD}â© Full copy cancelled${NC}"
            return 0
            ;;
    esac
    
    # Create destination directory
    local safe_id=$(echo "$device" | tr -d '[:punct:]' | cut -c1-8)
    local base_dir="$PWD/device-pull/${model}-${safe_id}"
    local timestamp=$(date +"%Y%m%d_%H-%M-%S")
    local dest_dir="${base_dir}/FULL-BACKUP-${timestamp}"
    
    mkdir -p "$dest_dir" 2>/dev/null
    
    echo -e "\n${CYAN}${BOLD}ğŸ“‚ Destination: ${WHITE}$dest_dir${NC}"
    echo -e "${YELLOW}${BOLD}âš ï¸  Make sure you have enough free space!${NC}"
    
    # Final confirmation
    echo -ne "\n${YELLOW}${BOLD}â“ Start full device copy? ${WHITE}(y/N) ${YELLOW}â¤ ${RED}"
    read confirm
    echo -ne "${NC}"
    
    case ${confirm,,} in
        n|no)
            echo -e "\n${BLUE}${BOLD}â© Copy cancelled${NC}"
            return 0
            ;;
    esac
    
    # Start pulling files with exclusions
    echo -e "\n${PURPLE}${BOLD}â¬‡ï¸  Copying ALL data from device...${NC}"
    echo -e "${YELLOW}${BOLD}This will take a VERY LONG time. Please be patient.${NC}\n"
    
    # Create a list of folders to copy (excluding system folders that might cause issues)
    local folders_to_copy=(
        "DCIM"
        "Download"
        "Music"
        "Movies"
        "Pictures"
        "Documents"
        "WhatsApp"
        "Podcasts"
        "Ringtones"
        "Alarms"
        "Notifications"
        "Android/media"
    )
    
    local total_folders=${#folders_to_copy[@]}
    local current=0
    
    for folder in "${folders_to_copy[@]}"; do
        current=$((current + 1))
        echo -e "\n${CYAN}${BOLD}[$current/$total_folders] Copying ${WHITE}$folder${NC}"
        
        # Check if folder exists
        if adb -s "$device" shell test -d "/sdcard/$folder" 2>/dev/null; then
            # Create destination subfolder
            mkdir -p "$dest_dir/$folder"
            
            # Copy folder with progress
            (
                adb -s "$device" pull "/sdcard/$folder/." "$dest_dir/$folder/" > .temp/pull_output.tmp 2>&1
            ) &
            
            local pid=$!
            local spin='-\|/'
            local i=0
            local last_file=""
            
            # Show progress while pulling
            while kill -0 $pid 2>/dev/null; do
                i=$(( (i+1) % 4 ))
                
                if [ -f ".temp/pull_output.tmp" ]; then
                    local current_file=$(tail -2 .temp/pull_output.tmp 2>/dev/null | grep -o "[^/]*$" | head -1 | cut -c1-40)
                    if [ -n "$current_file" ] && [ "$current_file" != "$last_file" ]; then
                        last_file="$current_file"
                        printf "\r${YELLOW}${BOLD}   â³ Copying: ${WHITE}%-40s ${spin:$i:1}${NC}" "${current_file:0:40}"
                    else
                        printf "\r${YELLOW}${BOLD}   â³ Copying folder ${spin:$i:1}${NC}                        "
                    fi
                else
                    printf "\r${YELLOW}${BOLD}   â³ Copying folder ${spin:$i:1}${NC}                        "
                fi
                
                sleep 0.5
            done
            
            wait $pid 2>/dev/null
            
            if [ $? -eq 0 ]; then
                local folder_size=$(du -sh "$dest_dir/$folder" 2>/dev/null | cut -f1)
                echo -e "\r${GREEN}${BOLD}   âœ… Copied ${WHITE}$folder ${GREEN}($folder_size)${NC}                      "
            else
                echo -e "\r${RED}${BOLD}   âŒ Failed to copy $folder${NC}"
            fi
        else
            echo -e "   ${YELLOW}âš ï¸  Folder not found, skipping${NC}"
        fi
    done
    
    # Copy additional important files from root of sdcard
    echo -e "\n${CYAN}${BOLD}[Extra] Copying root files...${NC}"
    mkdir -p "$dest_dir/Root"
    
    # Get list of files in root (excluding folders we already copied)
    adb -s "$device" shell ls -p /sdcard/ 2>/dev/null | grep -v '/' | while read file; do
        if [ -n "$file" ]; then
            echo -ne "${YELLOW}${BOLD}   Copying: ${WHITE}$file${NC}                   \r"
            adb -s "$device" pull "/sdcard/$file" "$dest_dir/Root/" > /dev/null 2>&1
        fi
    done
    echo -e "${GREEN}${BOLD}   âœ… Root files copied${NC}                         "
    
    # Show final summary
    echo -e "\n${GREEN}${BOLD}âœ… Full device copy completed!${NC}"
    show_copy_summary "$dest_dir"
    
    # Ask if user wants to open the folder
    echo -ne "\n${YELLOW}${BOLD}â“ Open backup folder? ${WHITE}(y/N) ${YELLOW}â¤ ${RED}"
    read folder_choice
    echo -ne "${NC}"
    
    case ${folder_choice,,} in
        y|yes)
            if command -v xdg-open &>/dev/null; then
                xdg-open "$dest_dir"
            elif command -v open &>/dev/null; then
                open "$dest_dir"
            else
                echo -e "${YELLOW}${BOLD}Folder: ${WHITE}$dest_dir${NC}"
            fi
            ;;
    esac
    
    # Create a backup info file
    cat > "$dest_dir/BACKUP_INFO.txt" << EOF
ANDRO-EYE FULL DEVICE BACKUP
============================
Device: $model
Device ID: $device
Backup Date: $(date)
Backup Time: $timestamp

Contents:
- Full sdcard backup including:
  * DCIM (Photos & Videos)
  * Downloads
  * Music
  * Movies
  * Pictures
  * Documents
  * WhatsApp Data
  * App Media (Android/media)
  * Root directory files

This backup was created using ANDRO-EYE Tool v2.32
EOF
    
    echo -e "\n${CYAN}${BOLD}ğŸ“„ Backup info file created${NC}"
    
    sparkle_effect
}

# Clear screen and show banner
clear
echo -e "${RED}${BOLD}"
cat << "EOF"
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•‘
    â•‘  â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•‘
    â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•‘
    â•‘  â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•‘
    â•‘  â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•‘
    â•‘  â•šâ•â•      â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•    â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â• â•‘
    â•‘                                                          â•‘
    â•‘        ğŸ’¿ ${GREEN}FULL DEVICE BACKUP${RED} - ${CYAN}Complete Storage Copy${RED}           â•‘
    â•‘                                                          â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}"
sparkle_effect

# Create necessary directories
mkdir -p .temp device-pull 2>/dev/null

## DEVICE ID EXTRACT ##
echo -e "\n${BLUE}${BOLD}ğŸ” Scanning for connected devices...${NC}"
loading_animation "Detecting devices"

# Check if ADB is working
if ! command -v adb &> /dev/null; then
    pulse_message "âŒ ADB not found! Please install ADB first." "${RED}"
    sleep 2
    bash modules/funtion.sh
    exit 1
fi

adb devices | sed -n '2,$p' | awk '{ print $1 }' > .temp/dev_list_temp 2>/dev/null

# Check if any devices found
if [ ! -s ".temp/dev_list_temp" ]; then
    echo -e "\n${RED}${BOLD}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${RED}${BOLD}â”‚${NC}  ${RED}${BLINK}âš ï¸${NC}  ${WHITE}NO DEVICES CONNECTED${NC}                       ${RED}${BOLD}â”‚${NC}"
    echo -e "${RED}${BOLD}â”‚${NC}      ${CYAN}Please connect a device for full backup${NC}                ${RED}${BOLD}â”‚${NC}"
    echo -e "${RED}${BOLD}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    
    echo -e "\n${YELLOW}${BOLD}Press Enter to return to main menu...${NC}"
    read
    clear
    bash modules/funtion.sh
    exit 0
fi

# Read devices into array properly
mapfile -t dev < .temp/dev_list_temp 2>/dev/null

# Assign device variables with null checking
dev_1="${dev[0]:-}"
dev_2="${dev[1]:-}"
dev_3="${dev[2]:-}"

## DEVICE MODEL EXTRACT ##
adb devices -l | grep "model:" > .temp/dev_list_model_temp 2>/dev/null

# Extract models properly
mod_1=""
mod_2=""
mod_3=""

if [ -s ".temp/dev_list_model_temp" ]; then
    mapfile -t model_lines < .temp/dev_list_model_temp
    
    for i in "${!model_lines[@]}"; do
        model=$(echo "${model_lines[$i]}" | grep -o 'model:[^ ]*' | cut -d':' -f2)
        
        case $i in
            0) mod_1="$model" ;;
            1) mod_2="$model" ;;
            2) mod_3="$model" ;;
        esac
    done
fi

# Proper device count logic
total_dev=0
[ -n "$dev_1" ] && total_dev=1
[ -n "$dev_2" ] && total_dev=2
[ -n "$dev_3" ] && total_dev=3

# Show existing backups count
if [ -d "device-pull" ]; then
    backup_count=$(find device-pull -type d -name "FULL-BACKUP-*" 2>/dev/null | wc -l)
    if [ "$backup_count" -gt 0 ]; then
        echo -e "\n${CYAN}${BOLD}ğŸ“ Previous full backups: ${WHITE}$backup_count${NC}"
        echo -e "${BLUE}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
        ls -ld device-pull/*/FULL-BACKUP-* 2>/dev/null | tail -n +1 | head -3 | while read line; do
            size=$(du -sh "$line" 2>/dev/null | cut -f1)
            echo -e "  ${GREEN}â€¢${NC} ${WHITE}$(basename $(dirname "$line"))/$(basename "$line") ${YELLOW}($size)${NC}"
        done
        echo -e "${BLUE}${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}\n"
    fi
fi

# Main device selection logic
echo -e "\n${GREEN}${BOLD}âœ… Scan Complete! Found ${WHITE}$total_dev${GREEN} device(s)${NC}\n"

case $total_dev in
    1)
        echo -e "${YELLOW}${BOLD}ğŸ“± Single device detected:${NC}\n"
        display_device_box "1" "$dev_1" "${mod_1:-Unknown}" "${GREEN}â— Ready${NC}"
        
        echo -e "\n${CYAN}${BOLD}Starting full device backup...${NC}"
        sleep 1
        pull_all_data "$dev_1" "${mod_1:-Unknown}" "1"
        ;;
        
    2)
        echo -e "${YELLOW}${BOLD}ğŸ“± Multiple devices detected:${NC}\n"
        display_device_box "1" "$dev_1" "${mod_1:-Unknown}" "${GREEN}â— Ready${NC}"
        echo
        display_device_box "2" "$dev_2" "${mod_2:-Unknown}" "${GREEN}â— Ready${NC}"
        
        echo -e "\n${CYAN}${BOLD}Select device for full backup:${NC}"
        while true; do
            echo -ne "\n${YELLOW}${BOLD}Enter device number (1-2) ${WHITE}â¤${NC} ${RED}"
            read options
            echo -ne "${NC}"
            
            case $options in
                1)
                    pull_all_data "$dev_1" "${mod_1:-Unknown}" "1"
                    break
                    ;;
                2)
                    pull_all_data "$dev_2" "${mod_2:-Unknown}" "2"
                    break
                    ;;
                *)
                    pulse_message "âŒ Invalid option! Choose 1 or 2" "${RED}"
                    ;;
            esac
        done
        ;;
        
    3)
        echo -e "${YELLOW}${BOLD}ğŸ“± Multiple devices detected:${NC}\n"
        display_device_box "1" "$dev_1" "${mod_1:-Unknown}" "${GREEN}â— Ready${NC}"
        echo
        display_device_box "2" "$dev_2" "${mod_2:-Unknown}" "${GREEN}â— Ready${NC}"
        echo
        display_device_box "3" "$dev_3" "${mod_3:-Unknown}" "${GREEN}â— Ready${NC}"
        
        echo -e "\n${CYAN}${BOLD}Select device for full backup:${NC}"
        while true; do
            echo -ne "\n${YELLOW}${BOLD}Enter device number (1-3) ${WHITE}â¤${NC} ${RED}"
            read options
            echo -ne "${NC}"
            
            case $options in
                1)
                    pull_all_data "$dev_1" "${mod_1:-Unknown}" "1"
                    break
                    ;;
                2)
                    pull_all_data "$dev_2" "${mod_2:-Unknown}" "2"
                    break
                    ;;
                3)
                    pull_all_data "$dev_3" "${mod_3:-Unknown}" "3"
                    break
                    ;;
                *)
                    pulse_message "âŒ Invalid option! Choose 1-3" "${RED}"
                    ;;
            esac
        done
        ;;
esac

# Clean up temp files
rm -f .temp/dev_list_temp .temp/dev_list_model_temp .temp/pull_output.tmp 2>/dev/null

# Return options
echo -e "\n${YELLOW}${BOLD}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${CYAN}${BOLD}â Options:${NC}"
echo -e "  ${GREEN}â€¢${NC} Press ${WHITE}ENTER${NC} to return to main menu"
echo -e "  ${GREEN}â€¢${NC} Type ${WHITE}'backup'${NC} to backup another device"
echo -e "  ${GREEN}â€¢${NC} Type ${WHITE}'folder'${NC} to open device-pull folder"
echo -e "  ${GREEN}â€¢${NC} Type ${WHITE}'exit'${NC} to quit\n"

echo -ne "${YELLOW}${BOLD}â“ Your choice ${WHITE}â¤${NC} ${RED}"
read user_choice
echo -ne "${NC}"

case ${user_choice,,} in
    "backup")
        echo -e "\n${PURPLE}${BOLD}ğŸ”„ Starting another backup...${NC}"
        sleep 1
        clear
        bash modules/opt22
        ;;
    "folder")
        echo -e "\n${BLUE}${BOLD}ğŸ“‚ Opening device-pull folder...${NC}"
        if command -v xdg-open &>/dev/null; then
            xdg-open "device-pull"
        elif command -v open &>/dev/null; then
            open "device-pull"
        else
            echo -e "${YELLOW}${BOLD}Folder: ${WHITE}$PWD/device-pull${NC}"
        fi
        sleep 2
        clear
        bash modules/opt22
        ;;
    "exit"|"quit")
        echo -e "\n${BLUE}${BOLD}ğŸ‘‹ Exiting to shell...${NC}"
        sparkle_effect
        exit 0
        ;;
    *)
        echo -e "\n${GREEN}${BOLD}â†©ï¸  Returning to main menu...${NC}"
        loading_animation "Loading"
        sleep 0.5
        clear
        bash modules/funtion.sh
        ;;
esac